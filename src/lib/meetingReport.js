/**
 * @typedef {Object} MeetingInfo
 * @property {string} [date] - íšŒì˜ ë‚ ì§œ
 * @property {string} [time] - íšŒì˜ ì‹œê°„
 * @property {string} [location] - íšŒì˜ ì¥ì†Œ
 * @property {string} [participants] - ì°¸ì„ì
 * @property {string} [purpose] - íšŒì˜ ëª©ì 
 * @property {string} [topic] - íšŒì˜ ì£¼ì œ
 */

// íšŒì˜ ì •ë³´ ì¶”ì¶œ í•¨ìˆ˜
/**
 * @param {string} text - ë¶„ì„í•  í…ìŠ¤íŠ¸
 * @returns {MeetingInfo} ì¶”ì¶œëœ íšŒì˜ ì •ë³´
 */
function extractMeetingInfo(text) {
	if (!text) return {};
	
	const info = {};
	
	// ë‚ ì§œ ì¶”ì¶œ
	const dateMatch = text.match(/íšŒì˜\s*ì¼ì‹œ[:\s]*([0-9ë…„ì›”ì¼\s]+)/);
	if (dateMatch) {
		info.date = dateMatch[1].trim();
	}
	
	// ì‹œê°„ ì¶”ì¶œ
	const timeMatch = text.match(/(ì˜¤ì „|ì˜¤í›„)\s*([0-9]+ì‹œ)/);
	if (timeMatch) {
		info.time = timeMatch[0].trim();
	}
	
	// ì¥ì†Œ ì¶”ì¶œ
	const locationMatch = text.match(/ì¥ì†Œ[:\s]*([^\n]+)/);
	if (locationMatch) {
		info.location = locationMatch[1].trim();
	}
	
	// ì°¸ì„ì ì¶”ì¶œ
	const participantsMatch = text.match(/ì°¸ì„ì[:\s]*([^\n]+)/);
	if (participantsMatch) {
		info.participants = participantsMatch[1].trim();
	}
	
	// ëª©ì /ëª©í‘œ ì¶”ì¶œ (ì•ˆê±´, ëª©ì , ëª©í‘œ ë“± ë‹¤ì–‘í•œ í‘œí˜„ ëŒ€ì‘)
	const purposeMatch = text.match(/(?:ì•ˆê±´|ëª©ì |ëª©í‘œ)[:\s]*([^\n]+)/);
	if (purposeMatch) {
		info.purpose = purposeMatch[1].trim();
	}
	
	// ì£¼ì œ ì¶”ì¶œ (ì£¼ì œ, ë…¼ì˜ì‚¬í•­ ë“± ë‹¤ì–‘í•œ í‘œí˜„ ëŒ€ì‘)
	const topicMatch = text.match(/(?:ì£¼ì œ|ë…¼ì˜ì‚¬í•­|ì•ˆê±´)[:\s]*([^\n]+)/);
	if (topicMatch) {
		info.topic = topicMatch[1].trim();
	}
	
	// ê²°ë¡  ì¶”ì¶œ
	const conclusionMatch = text.match(/ê²°ë¡ [:\s]*([^\n]+)/);
	if (conclusionMatch) {
		info.conclusion = conclusionMatch[1].trim();
	}
	
	// ë‹¤ìŒ íšŒì˜ ì¶”ì¶œ
	const nextMeetingMatch = text.match(/ë‹¤ìŒ\s*íšŒì˜[:\s]*([^\n]+)/);
	if (nextMeetingMatch) {
		info.nextMeeting = nextMeetingMatch[1].trim();
	}
	
	return info;
}

// ë°”ì´ë„ˆë¦¬ ë°ì´í„° ê°ì§€ í•¨ìˆ˜
/**
 * @param {string} text - ê²€ì‚¬í•  í…ìŠ¤íŠ¸
 * @returns {boolean} ë°”ì´ë„ˆë¦¬ ë°ì´í„° í¬í•¨ ì—¬ë¶€
 */
function isBinaryData(text) {
	// MP4/MP3 ë°”ì´ë„ˆë¦¬ ë©”íƒ€ë°ì´í„° íŒ¨í„´
	const binaryPatterns = [
		'mdhd', 'trak', 'stco', 'stsz', 'stsc', 'mdia', 'minf', 'smhd',
		'hdlr', 'dinf', 'dref', 'stbl', 'mp4a', 'avc1', 'tkhd', 'mdat',
		'moov', 'mvhd', 'udta', 'stco', 'stsz', 'stsc', 'mdia', 'minf',
		'smhd', 'hdlr', 'dinf', 'dref', 'stbl', 'mp4a', 'avc1', 'tkhd',
		'mdat', 'moov', 'mvhd', 'udta', 'stco', 'stsz', 'stsc', 'mdia',
		'minf', 'smhd', 'hdlr', 'dinf', 'dref', 'stbl', 'mp4a', 'avc1',
		'tkhd', 'mdat', 'moov', 'mvhd', 'udta'
	];
	
	// ë°”ì´ë„ˆë¦¬ íŒ¨í„´ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
	const hasBinaryPattern = binaryPatterns.some(pattern => 
		text.toLowerCase().includes(pattern.toLowerCase())
	);
	
	// íŠ¹ìˆ˜ ë°”ì´ë„ˆë¦¬ ë¬¸ì íŒ¨í„´ (86 ë“±)
	const hasSpecialBinary = /[^\u0000-\u007F\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F\s\w\.,!?;:()[\]{}"'\-]/g.test(text);
	
	// ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¡œ íŒë‹¨ë˜ëŠ” ê²½ìš°
	return hasBinaryPattern || hasSpecialBinary;
}

// íšŒì˜ ë‚´ìš© ìš”ì•½ í•¨ìˆ˜ (100ì¤„ ê¸°ì¤€, íŒŒì¼ë³„ ì²˜ë¦¬)
/**
 * @param {string} text - ìš”ì•½í•  í…ìŠ¤íŠ¸
 * @param {string} [filename] - íŒŒì¼ëª… (í™•ì¥ìë¡œ íŒŒì¼ íƒ€ì… íŒë‹¨)
 * @returns {string} ìš”ì•½ëœ í…ìŠ¤íŠ¸
 */
function generateMeetingSummary(text, filename = '') {
	if (!text || text.trim().length === 0) {
		return 'íšŒì˜ ë‚´ìš©ì„ ìš”ì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
	}
	
	// íŒŒì¼ í™•ì¥ìì— ë”°ë¥¸ í…ìŠ¤íŠ¸ ì •ì œ
	let cleanedText = text;
	
	if (filename) {
		const extension = filename.toLowerCase().split('.').pop();
		
		switch (extension) {
			case 'pdf':
				// PDFì—ì„œ í•œê¸€ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ (ê°•í™”ëœ ì •ì œ)
				cleanedText = text
					// 1ë‹¨ê³„: PDF ë©”íƒ€ë°ì´í„° ë° ë°”ì´ë„ˆë¦¬ ì •ë³´ ì™„ì „ ì œê±°
					.replace(/CMYK[\s\S]*?endstream/g, '') // CMYK ì •ë³´ ì œê±°
					.replace(/Adobe PDF library[\s\S]*?endobj/g, '') // Adobe ì •ë³´ ì œê±°
					.replace(/stream[\s\S]*?endstream/g, '') // stream ì •ë³´ ì œê±°
					.replace(/obj[\s\S]*?endobj/g, '') // obj ì •ë³´ ì œê±°
					.replace(/C=\d+\s+M=\d+\s+Y=\d+\s+K=\d+/g, '') // CMYK ìƒ‰ìƒ ì •ë³´ ì œê±°
					.replace(/PROCESS[\s\S]*?\d+\.\d+/g, '') // PROCESS ì •ë³´ ì œê±°
					.replace(/startxref[\s\S]*?%%EOF/g, '') // PDF ëë¶€ë¶„ ì •ë³´ ì œê±°
					.replace(/endstream[\s\S]*?endobj/g, '') // endstream-endobj ë¸”ë¡ ì œê±°
					.replace(/h[^]*/g, '') // ë°”ì´ë„ˆë¦¬ ë°ì´í„° ì œê±°
					.replace(/[^\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F\s]/g, '') // í•œê¸€ê³¼ ê³µë°±ë§Œ ìœ ì§€
					.replace(/\s+/g, ' ') // ì—°ì† ê³µë°± ì •ë¦¬
					.trim();
				
				// 2ë‹¨ê³„: í•œê¸€ ë¬¸ì¥ë§Œ ì¶”ì¶œ (í•œê¸€ì´ í¬í•¨ëœ ì¤„ë§Œ)
				const lines = cleanedText.split('\n');
				const koreanLines = lines.filter(line => {
					const koreanCount = (line.match(/[\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F]/g) || []).length;
					return koreanCount > 0 && line.trim().length > 2;
				});
				
				cleanedText = koreanLines.join('\n');
				
				// 3ë‹¨ê³„: í•œê¸€ì´ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
				if (!cleanedText || cleanedText.trim().length < 5) {
					cleanedText = 'PDF íŒŒì¼ì—ì„œ í•œê¸€ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•œê¸€ì´ í¬í•¨ëœ PDF íŒŒì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
				}
				break;
				
			case 'doc':
			case 'docx':
				// Word ë¬¸ì„œ ë©”íƒ€ë°ì´í„° ì œê±°, ê¹¨ì§„ ê¸€ì ì œê±°
				cleanedText = text
					.replace(/Microsoft Word[\s\S]*?Document/g, '') // Word ë©”íƒ€ë°ì´í„° ì œê±°
					.replace(/[^\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F\s\w\.,!?;:()[\]{}"'\-]/g, '') // ê¹¨ì§„ ê¸€ì ì™„ì „ ì œê±°
					.replace(/\s+/g, ' ') // ì—°ì† ê³µë°± ì •ë¦¬
					.trim();
				break;
				
			case 'mp3':
			case 'wav':
				// ì˜¤ë””ì˜¤ íŒŒì¼: Whisper API ì²˜ë¦¬ ê²°ê³¼ í™•ì¸
				if (text.includes('ìŒì„± ì¸ì‹ ì‹¤íŒ¨') || text.includes('API í‚¤') || text.includes('ìŒì„± ì¸ì‹ ê²°ê³¼') || 
					text.includes('Whisper API') || text.includes('ìŒì„± ì¸ì‹ ê²°ê³¼')) {
					// Whisper API ì²˜ë¦¬ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš°
					cleanedText = text;
				} else if (isBinaryData(text)) {
					// ë°”ì´ë„ˆë¦¬ ë°ì´í„°ê°€ ê°ì§€ëœ ê²½ìš°
					cleanedText = 'ğŸµ ì˜¤ë””ì˜¤ íŒŒì¼ì…ë‹ˆë‹¤.\n\n' +
						'âš ï¸ ìŒì„± ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n' +
						'ğŸ“‹ í•´ê²° ë°©ë²•:\n' +
						'1. OpenAI API í‚¤ ì„¤ì • í™•ì¸\n' +
						'2. server/.env íŒŒì¼ì— OPENAI_API_KEY ì…ë ¥\n' +
						'3. ì„œë²„ ì¬ì‹œì‘\n' +
						'4. API í¬ë ˆë”§ í™•ì¸\n\n' +
						'ğŸ’¡ ì„ì‹œ í•´ê²°ì±…: ìŒì„± íŒŒì¼ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ í›„ .txt íŒŒì¼ë¡œ ì—…ë¡œë“œ';
				} else {
					// ê¸°íƒ€ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ê°€ ê·¸ëŒ€ë¡œ ë‚˜ì˜¨ ê²½ìš°
					cleanedText = 'ğŸµ ì˜¤ë””ì˜¤ íŒŒì¼ì…ë‹ˆë‹¤.\n\n' +
						'âš ï¸ ìŒì„± ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n' +
						'ğŸ“‹ í•´ê²° ë°©ë²•:\n' +
						'1. OpenAI API í‚¤ ì„¤ì • í™•ì¸\n' +
						'2. server/.env íŒŒì¼ì— OPENAI_API_KEY ì…ë ¥\n' +
						'3. ì„œë²„ ì¬ì‹œì‘\n' +
						'4. API í¬ë ˆë”§ í™•ì¸\n\n' +
						'ğŸ’¡ ì„ì‹œ í•´ê²°ì±…: ìŒì„± íŒŒì¼ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ í›„ .txt íŒŒì¼ë¡œ ì—…ë¡œë“œ';
				}
				break;
				
			case 'mp4':
			case 'avi':
			case 'mov':
				// ë¹„ë””ì˜¤ íŒŒì¼: Whisper API ì²˜ë¦¬ ê²°ê³¼ í™•ì¸
				if (text.includes('ìŒì„± ì¸ì‹ ì‹¤íŒ¨') || text.includes('API í‚¤') || text.includes('ìŒì„± ì¸ì‹ ê²°ê³¼') || 
					text.includes('Whisper API') || text.includes('ìŒì„± ì¸ì‹ ê²°ê³¼')) {
					// Whisper API ì²˜ë¦¬ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš°
					cleanedText = text;
				} else if (isBinaryData(text)) {
					// ë°”ì´ë„ˆë¦¬ ë°ì´í„°ê°€ ê°ì§€ëœ ê²½ìš°
					cleanedText = 'ğŸ¬ ë¹„ë””ì˜¤ íŒŒì¼ì…ë‹ˆë‹¤.\n\n' +
						'âš ï¸ ìŒì„± ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n' +
						'ğŸ“‹ í•´ê²° ë°©ë²•:\n' +
						'1. OpenAI API í‚¤ ì„¤ì • í™•ì¸\n' +
						'2. server/.env íŒŒì¼ì— OPENAI_API_KEY ì…ë ¥\n' +
						'3. ì„œë²„ ì¬ì‹œì‘\n' +
						'4. API í¬ë ˆë”§ í™•ì¸\n\n' +
						'ğŸ’¡ ì„ì‹œ í•´ê²°ì±…: ë¹„ë””ì˜¤ íŒŒì¼ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ í›„ .txt íŒŒì¼ë¡œ ì—…ë¡œë“œ';
				} else {
					// ê¸°íƒ€ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ê°€ ê·¸ëŒ€ë¡œ ë‚˜ì˜¨ ê²½ìš°
					cleanedText = 'ğŸ¬ ë¹„ë””ì˜¤ íŒŒì¼ì…ë‹ˆë‹¤.\n\n' +
						'âš ï¸ ìŒì„± ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n' +
						'ğŸ“‹ í•´ê²° ë°©ë²•:\n' +
						'1. OpenAI API í‚¤ ì„¤ì • í™•ì¸\n' +
						'2. server/.env íŒŒì¼ì— OPENAI_API_KEY ì…ë ¥\n' +
						'3. ì„œë²„ ì¬ì‹œì‘\n' +
						'4. API í¬ë ˆë”§ í™•ì¸\n\n' +
						'ğŸ’¡ ì„ì‹œ í•´ê²°ì±…: ë¹„ë””ì˜¤ íŒŒì¼ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ í›„ .txt íŒŒì¼ë¡œ ì—…ë¡œë“œ';
				}
				break;
				
			default:
				// txt ë“± í…ìŠ¤íŠ¸ íŒŒì¼ì€ ê¹¨ì§„ ê¸€ìë§Œ ì œê±°
				cleanedText = text
					.replace(/[^\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F\s\w\.,!?;:()[\]{}"'\-]/g, '') // ê¹¨ì§„ ê¸€ì ì™„ì „ ì œê±°
					.replace(/\s+/g, ' ') // ì—°ì† ê³µë°± ì •ë¦¬
					.trim();
				break;
		}
	}
	
	// ì •ì œëœ í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì›ë³¸ ì‚¬ìš©
	if (!cleanedText || cleanedText.trim().length === 0) {
		cleanedText = text;
	}
	
	// í…ìŠ¤íŠ¸ë¥¼ ì¤„ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ê³  ì—”í„°ì™€ ë¹ˆ ì¤„ ëª¨ë‘ ìœ ì§€
	const lines = cleanedText.split('\n');
	
	// 100ì¤„ ì´í•˜ë©´ ì „ì²´ ë‚´ìš© ë°˜í™˜
	if (lines.length <= 100) {
		return lines.join('\n');
	}
	
	// 100ì¤„ì„ ë„˜ìœ¼ë©´ ë§ˆì§€ë§‰ 100ì¤„ì˜ ì²« ë²ˆì§¸ ë¬¸ë‹¨ë¶€í„° ì‹œì‘
	const last100Start = Math.max(0, lines.length - 100);
	let startIndex = last100Start;
	
	// ë§ˆì§€ë§‰ 100ì¤„ ë‚´ì—ì„œ ì²« ë²ˆì§¸ ë¬¸ë‹¨ ì‹œì‘ì  ì°¾ê¸° (ë¹ˆ ì¤„ ë‹¤ìŒì— ì˜¤ëŠ” ì²« ë²ˆì§¸ ë‚´ìš©)
	for (let i = last100Start; i < lines.length; i++) {
		if (lines[i].length > 0) {
			startIndex = i;
			break;
		}
	}
	
	// ë§ˆì§€ë§‰ 100ì¤„ë¶€í„° ëê¹Œì§€ ì¶”ì¶œ
	const selectedLines = lines.slice(startIndex);
	return selectedLines.join('\n');
}

// ê³µí†µ íšŒì˜ë¡ ìƒì„± í•¨ìˆ˜
/**
 * @typedef {Object} Speaker
 * @property {string} name - í™”ì ì´ë¦„
 * @property {number} percentage - ë°œì–¸ ë¹„ìœ¨
 */

/**
 * @param {Object} analysisResults - ë¶„ì„ ê²°ê³¼ ê°ì²´
 * @param {string} analysisResults.extractedText - ì¶”ì¶œëœ í…ìŠ¤íŠ¸
 * @param {Array<Speaker>} [analysisResults.speakers] - í™”ì ì •ë³´ ë°°ì—´
 * @param {string} [analysisResults.filename] - íŒŒì¼ëª…
 * @param {string} currentDate - í˜„ì¬ ë‚ ì§œ
 * @returns {string} HTML í˜•ì‹ì˜ íšŒì˜ë¡
 */
export function generateCommonMeetingReport(analysisResults, currentDate) {
	// extractedTextì—ì„œ íšŒì˜ ì •ë³´ ì¶”ì¶œ
	const meetingInfo = extractMeetingInfo(analysisResults.extractedText || '');
	
	return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì˜ë¡ - ${meetingInfo.date || currentDate}</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', sans-serif; 
            margin: 40px; 
            line-height: 1.6;
            color: #333;
        }
        .header { 
            text-align: center; 
            margin-bottom: 40px; 
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }
        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .meeting-info { 
            margin-bottom: 30px; 
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
        }
        .section { 
            margin-bottom: 30px; 
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .section h3 {
            background: #667eea;
            color: white;
            margin: 0;
            padding: 15px 20px;
            font-size: 1.3rem;
        }
        .section-content {
            padding: 20px;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 15px 0; 
            background: white;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 15px; 
            text-align: left; 
        }
        th { 
            background-color: #f1f5f9; 
            font-weight: 600;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ íšŒì˜ë¡</h1>
        <p>ìƒì„± ì¼ì‹œ: ${currentDate}</p>
    </div>
    
    <div class="meeting-info">
        <h2>ğŸ“… íšŒì˜ ê¸°ë³¸ ì •ë³´</h2>
        <table>
            <tr>
                <th>êµ¬ë¶„</th>
                <th>ë‚´ìš©</th>
            </tr>
            <tr>
                <td>ğŸ“… ë‚ ì§œ</td>
                <td>${meetingInfo.date || ''}</td>
            </tr>
            <tr>
                <td>â° ì‹œê°„</td>
                <td>${meetingInfo.time || ''}</td>
            </tr>
            <tr>
                <td>ğŸ“ ì¥ì†Œ</td>
                <td>${meetingInfo.location || ''}</td>
            </tr>
            <tr>
                <td>ğŸ‘¥ ì°¸ì„ì</td>
                <td>${meetingInfo.participants || analysisResults.speakers?.map(s => s.name).join(', ') || ''}</td>
            </tr>
            <tr>
                <td>ğŸ¯ ëª©ì /ëª©í‘œ</td>
                <td>${meetingInfo.purpose || ''}</td>
            </tr>
            <tr>
                <td>ğŸ“‹ ì£¼ì œ</td>
                <td>${meetingInfo.topic || ''}</td>
            </tr>
        </table>
    </div>
    
    <div class="section">
        <h3>ğŸ“ íšŒì˜ ë‚´ìš©</h3>
        <div class="section-content">
            <p>${analysisResults.extractedText ? generateMeetingSummary(analysisResults.extractedText, analysisResults.filename || '').replace(/\n/g, '<br>') : 'íšŒì˜ ë‚´ìš©ì„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</p>
        </div>
    </div>
</body>
</html>`;
}
